name: Pixel OS KSU-Next Enhanced
on:
    workflow_dispatch:
      inputs:
        RELEASE_CONFIG:
          description: 'Upload to Releases'
          required: true
          default: true
          type: boolean
        KERNEL_SOURCE:
          description: 'Kernel Source'
          required: true
          default: "https://github.com/beet-stuffs/android_kernel_oneplus_sm8350"
          type: string
        KERNEL_SOURCE_BRANCH:
          description: 'Kernel Branch'
          required: true
          default: "fourteen-qpr2"
          type: string
        KERNEL_DEFCONFIG:
          description: 'Kernel Config'
          required: true
          default: "vendor/lahaina-qgki_defconfig"
          type: string
        KERNELSU_CONFIG:
          description: 'Compile KernelSU-Next'
          required: true
          default: true
          type: boolean
        CCACHE_CONFIG:
          description: 'Use Ccache'
          required: true
          default: true
          type: boolean
jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_MAXSIZE: "2G"
      CCACHE_HARDLINK: "true"
    steps:
      - uses: actions/checkout@v4
      - name: Ccache
        if: github.event.inputs.CCACHE_CONFIG == 'true'
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: PixelOS-KSUNext-Enhanced-inline
      - name: Setup Environment
        run: |
          export CLANG_PATH=~/clang
          git clone --depth=1 https://github.com/kdrag0n/proton-clang $CLANG_PATH
          sh -c "$(curl -sSL https://raw.githubusercontent.com/akhilnarang/scripts/master/setup/android_build_env.sh)"
          sudo apt update && sudo apt install -y bc bison build-essential ccache flex g++-multilib gcc-multilib git gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev libelf-dev liblz4-tool libncurses5-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils lz4 lld lldb llvm lzma ncurses-dev pngcrush schedtool squashfs-tools xsltproc zip zlib1g-dev
      - name: Git kernel
        run: |
          git clone "${{ github.event.inputs.KERNEL_SOURCE }}" -b "${{ github.event.inputs.KERNEL_SOURCE_BRANCH }}" kernel --depth=1
          echo "TAG_NAME=v5.4.$(grep "^SUBLEVEL =" kernel/Makefile | awk '{print $3 }')-$(date +"%Y%m%d")-ThinLTO-CAF" >> $GITHUB_ENV
      - name: Setup KernelSU-Next
        if: github.event.inputs.KERNELSU_CONFIG == 'true'
        run: |
          cd $GITHUB_WORKSPACE/kernel
          curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -s next
          scripts/config --file "arch/arm64/configs/${{ github.event.inputs.KERNEL_DEFCONFIG }}" -e MODULES -e KPROBES -e HAVE_KPROBES -e KPROBE_EVENTS
      - name: Merge latest CAF tag (LA.UM.9.14.r1-26000-LAHAINA.QSSI15.0)
        run: |
          cd $GITHUB_WORKSPACE/kernel
          git fetch https://git.codelinaro.org/clo/la/kernel/msm-5.4 LA.UM.9.14.r1-26000-LAHAINA.QSSI15.0
          git merge FETCH_HEAD --no-edit
      - name: Add Boeffla wakelock blocker
        run: |
          cd $GITHUB_WORKSPACE/kernel
          curl -L https://raw.githubusercontent.com/engstk/patches/master/boeffla_wakelock_blocker_generic.patch | git apply
      - name: Add KCAL advanced color control
        run: |
          cd $GITHUB_WORKSPACE/kernel
          curl -L https://raw.githubusercontent.com/engstk/patches/master/kcal.patch | git apply
      - name: Make kernel
        run: |
          cd $GITHUB_WORKSPACE/kernel
          export KERNEL_DEFCONFIG=${{ github.event.inputs.KERNEL_DEFCONFIG }}
          export CLANG_PATH=~/clang
          export PATH=${CLANG_PATH}/bin:${PATH}
          export ARCH=arm64
          export SUBARCH=arm64
          make O=out CC="ccache clang" CXX="ccache clang++" ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi- LD=ld.lld $KERNEL_DEFCONFIG
          # Force ThinLTO â€” best performance/size ratio on SM8350
          scripts/config --file out/.config -d CONFIG_LTO_NONE -e CONFIG_LTO_CLANG -e CONFIG_THINLTO
          make O=out olddefconfig
          make O=out CC="ccache clang" CXX="ccache clang++" ARCH=arm64 -j$(nproc) CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi- LD=ld.lld 2>&1 | tee kernel.log
          if [ ! -f out/arch/arm64/boot/Image ]; then
            echo "BUILD FAILED"
            exit 1
          fi
      - name: Create AnyKernel3 zip
        run: |
          cd $GITHUB_WORKSPACE/kernel
          git clone https://gitlab.com/inferno0230/AnyKernel3.git --depth=1 AnyKernel3
          zip_name="PixelOS-KSUNext-Enhanced-martini-${{ env.TAG_NAME }}.zip"
          cp out/arch/arm64/boot/Image AnyKernel3/
          cd AnyKernel3
          zip -r9 ../${zip_name} *
          cd ..
          mv ${zip_name} out/arch/arm64/boot/
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PixelOS-KSUNext-Enhanced-martini-${{ env.TAG_NAME }}
          path: kernel/out/arch/arm64/boot/*.zip
      - name: Upload to Release
        if: github.event.inputs.RELEASE_CONFIG == 'true'
        uses: ncipollo/release-action@v1
        with:
          artifacts: "kernel/out/arch/arm64/boot/PixelOS-KSUNext-Enhanced-martini-${{ env.TAG_NAME }}.zip"
          tag: "ONEPLUS9RT-PixelOS-KSUNext-Enhanced-${{ env.TAG_NAME }}"
          name: "PixelOS KSUNext Enhanced martini ${{ env.TAG_NAME }}"
          allowUpdates: true
          replacesArtifacts: true
          token: ${{ secrets.GITHUB_TOKEN }}
