name: OnePlus 9RT • SukiSU Ultra (No SUSFS) - Nov 2025

on:
  workflow_dispatch:
    inputs:
      RELEASE_CONFIG:
        default: true
        type: boolean
      KERNEL_DEFCONFIG:
        default: "vendor/lahaina-qgki_defconfig"
        type: string
      CCACHE_CONFIG:
        default: true
        type: boolean

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_MAXSIZE: "2G"
      CCACHE_HARDLINK: "true"

    steps:
      - uses: actions/checkout@v4

      - name: Ccache
        if: github.event.inputs.CCACHE_CONFIG == 'true'
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: 9RT-SukiSU-Ultra-2025-11-22

      - name: Setup Environment + Proton Clang
        run: |
          sudo apt update
          sudo apt install -y bc bison flex libelf-dev libssl-dev libclang-dev
          export CLANG_PATH=~/proton-clang
          git clone --depth=1 https://github.com/kdrag0n/proton-clang $CLANG_PATH
          sh -c "$(curl -sSL https://raw.githubusercontent.com/akhilnarang/scripts/master/setup/android_build_env.sh)"

      - name: Clone Kernel Source
        run: |
          git clone https://github.com/natsumerinchan/android_kernel_oneplus_sm8350.git -b fourteen-qpr3 kernel --depth=1
          echo "TAG_NAME=v5.4.$(grep "^SUBLEVEL =" kernel/Makefile | awk '{print $3}')-$(date +"%Y%m%d")" >> $GITHUB_ENV

      - name: Integrate Latest SukiSU Ultra (main branch = no SUSFS)
        run: |
          cd kernel
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -
          # Force required options (safety)
          scripts/config --file "arch/arm64/configs/${{ github.event.inputs.KERNEL_DEFCONFIG }}" \
            -e MODULES -e KPROBES -e HAVE_KPROBES -e KPROBE_EVENTS -e CONFIG_KSU

      - name: Build Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export SUBARCH=arm64
          export CLANG_PATH=~/proton-clang
          export PATH="$CLANG_PATH/bin:$PATH"

          make O=out \
            CC="ccache clang" \
            CXX="ccache clang++" \
            CROSS_COMPILE="$CLANG_PATH/bin/aarch64-linux-gnu-" \
            CROSS_COMPILE_ARM32="$CLANG_PATH/bin/arm-linux-gnueabi-" \
            LD=ld.lld \
            AR=llvm-ar \
            NM=llvm-nm \
            OBJCOPY=llvm-objcopy \
            OBJDUMP=llvm-objdump \
            STRIP=llvm-strip \
            ${{ github.event.inputs.KERNEL_DEFCONFIG }}

          # Disable LTO on low RAM runner (this is the #1 cause of silent linking death on GitHub)
          if [ $(awk '/MemTotal/ {print $2}' /proc/meminfo) -lt 16000000 ]; then
            scripts/config --file out/.config -d LTO_CLANG -d THINLTO -d LTO_CLANG_THIN -e LTO_NONE
            make O=out olddefconfig
          fi

          make O=out \
            CC="ccache clang" \
            CXX="ccache clang++" \
            CROSS_COMPILE="$CLANG_PATH/bin/aarch64-linux-gnu-" \
            CROSS_COMPILE_ARM32="$CLANG_PATH/bin/arm-linux-gnueabi-" \
            LD=ld.lld \
            AR=llvm-ar \
            NM=llvm-nm \
            OBJCOPY=llvm-objcopy \
            OBJDUMP=llvm-objdump \
            STRIP=llvm-strip \
            -j$(nproc --all) 2>&1 | tee build.log

          [ -f out/arch/arm64/boot/Image ] || (echo "BUILD FAILED - Image not found" && cat build.log | tail -50 && exit 1)

      - name: Package with AnyKernel3
        run: |
          cd kernel
          git clone https://github.com/osm0sis/AnyKernel3 --depth=1
          cp out/arch/arm64/boot/Image AnyKernel3/
          cd AnyKernel3
          zip -r9 "../SukiSU-Ultra-martini-${{ env.TAG_NAME }}.zip" * -x .git README.md
          mv "../SukiSU-Ultra-martini-${{ env.TAG_NAME }}.zip" ../out/arch/arm64/boot/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SukiSU-Ultra-martini-${{ env.TAG_NAME }}
          path: kernel/out/arch/arm64/boot/*.zip

      - name: Upload to Release
        if: github.event.inputs.RELEASE_CONFIG == 'true'
        uses: ncipollo/release-action@v1
        with:
          artifacts: "kernel/out/arch/arm64/boot/SukiSU-Ultra-martini-${{ env.TAG_NAME }}.zip"
          tag: "9RT-SukiSU-Ultra-${{ env.TAG_NAME }}"
          name: "OnePlus 9RT • SukiSU Ultra ${{ env.TAG_NAME }}"
          allowUpdates: true
          replacesArtifacts: true
          token: ${{ secrets.GITHUB_TOKEN }}
